<div class="container mt-4 custom-container">

  <!--                        CALENDRIER                            -->
  <%= week_calendar(number_of_weeks: 1, events: @presence_periods+@calendar_events) do |date, events| %>
    <%= date.day %>


    <!-- DESKTOP -->
    <% events.each do |event| %>
        <!-- presence days -->
      <% if !event.is_a? Event %>
        <div class="desktop_only">
          <div class="d-flex justify-content-around calendar-user-presence-periods">
            <% event.users.each do |user| %>
              <div class="sm-txt-avatar <%= user.color %>"><%= user.first_name[0] %></div>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- events: sale, admin, dated_admin -->
        <div class="bgcolor-<%= @event_colors[event.event_subcategory.to_sym] %> desktop_only">
          <div class="d-flex justify-content-between pt-2 pl-1 pointer" data-drawer-trigger aria-controls="drawer-event-<%= event.id %>" aria-expanded="false">
            <div class="text-left"><%= event.description[0..30] %><%= event.description.length > 31 ? "..." : "" %></div>
            <div class="d-flex flex-wrap">
              <% event.users.each do |user| %>
              <div class="d-flex pr-1">
                <div class="text-white sm-txt-avatar <%= user.color %>"><%= user.first_name[0] %></div>
              </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- MOBILE -->
    <% events.each do |event| %>
         <!-- presence days -->
      <% if !event.is_a? Event %>
        <div class="mobile_only">
          <div class="d-flex justify-content-around calendar-user-presence-periods">
            <% event.users.each do |user| %>
              <div class="vsm-txt-avatar <%= user.color %>"><%= user.first_name[0] %></div>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- events: sale, admin, dated_admin -->
        <div class="dashboard-calendar-event bgcolor-<%= @event_colors[event.event_subcategory.to_sym] %> mobile_only">
          <div class="d-flex">
            <% event.users.each do |user| %>
              <div class="m-1 text-white vsm-txt-avatar <%= user.color %>">
                <%= user.first_name[0] %>
              </div>
            <% end %>
          </div>
          <div class="d-flex justify-content-between px-1" data-drawer-trigger aria-controls="drawer-event-<%= event.id %>" >
            <div class="text-left">
              <p><%= event.description[0..8] %><%= event.description.length > 9 ? "…" : "" %></p>
            </div>
          </div>
        </div>
        <section class="drawer" id="drawer-event-<%= event.id %>" data-drawer-target>
          <div class="drawer__overlay" data-drawer-close tabindex="-1"></div>
          <div class="drawer__wrapper">
            <div class="drawer__header">
              <div class="d-flex justify-content-between">
                <div class="drawer__title">
                  <div><h2><%= event.description %></h2></div>
                  <div class="drawer-title-second-line"><%= l(event.start_time, format: '%A %e %B %Y') %></div>
                  <% if event.end_time %>
                    <div class="drawer-title-second-line">De <%= l(event.start_time, format: '%Hh%M') %> à <%= l(event.end_time, format: '%Hh%M') %></div>
                  <% else %>
                    <div class="drawer-title-second-line">À <%= l(event.start_time, format: '%Hh%M') %></div>
                  <% end %>
                </div>
                <button class="drawer__close" data-drawer-close aria-label="Close Drawer">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="drawer__content">
              <% if event.users.any? %>
                <h4 class="pt-3">Qui s'en charge ?</h4>
                <p>
                  <%= event.users.map{|user| user.first_name}.to_sentence(words_connector: ', ', last_word_connector: ' et ') %>
                </p>
              <% end %>
              <% if !event.comment.nil? %>
                <h4 class="pt-3">Commentaire</h4>
                <p>
                  <%= event.comment %>
                </p>
              <% end %>
            </div>
          </div>
        </section>
      <% end %>
    <% end %>
  <% end %>
  <div class="d-sm-flex justify-content-between">

      <!--                  FROM THE PLAN DE CULTURE                 -->
      <%= render "pages/dashboard_sections/crop_plan_line_events", week_planting: @week_planting, week_bed_preparation_2_weeks: @week_bed_preparation_2_weeks, week_bed_preparation_1_week: @week_bed_preparation_1_week, week_harvesting: @week_harvesting, event: @new_event, farm: @farm %>


    <div class="w-48-desktop">
      <!--                  décharge mentale DÉCHARGE MENTALE decharge mentale DECHARGE MENTALE                -->
      <%= render "pages/dashboard_sections/admin_events" %>


      <!--                  TOUR DES JARDINS                 -->
      <div class="mt-4 dashboard-crop-plan-line-card red">
        <div class="card-colored-top-part-fixed-color red">
          <div class="card-top-part-text">Tour des jardins  👀</div>
        </div>
        <div class="card-bottom-part">
          <div class="card-bottom-part-text">
            <div class="mt-2">
              <% if @garden_events.empty? %>
              <p><%= "Pas de tâches de jardin cette semaine 😅"  %></p>
              <% end %>
              <% @garden_events.each do |garden_event| %>
                <div class="d-flex justify-content-between card-list-item-block">
                  <div class="card-list-item-left-block">
                    <div class="desktop_only">
                      <%= link_to farm_calendrier_path(@farm, garden_event, event_done: true), method: :patch do %>
                        <div class="round-button <%= garden_event.date_done.nil? ? 'green' : 'olive' %> m-2">
                          <i class="fas fa-check round-txt-button"></i>
                        </div>
                      <% end %>
                    </div>
                    <div class="card-list-item-main-info-block">
                      <div>
                        <p><%= garden_event.description.capitalize %></p>
                      </div>
                      <div class="card-list-item-second-line"><%= garden_event.details.capitalize %></div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between card-list-item-round-button-block">
                    <div>
                      <div class="round-button green mobile_only m-2">
                        <i class="fas fa-check round-txt-button"></i>
                      </div>
                    </div>
                    <div class="d-flex">
                      <div class="round-button <%= garden_event.comment.nil? || garden_event.comment.empty? ? 'lightgrey' : 'green' %> m-2" data-drawer-trigger aria-controls="drawer-tour-des-jardins-comment-<%= garden_event.id %>" aria-expanded="false">
                        <i class="fas fa-comment round-txt-button"></i>
                      </div>
                      <div class="round-button orange m-2" data-drawer-trigger aria-controls="drawer-tour-des-jardins-edit-<%= garden_event.id %>" aria-expanded="false">
                        <i class="fas fa-pen round-txt-button"></i>
                      </div>
                      <%= link_to farm_calendrier_path(@farm, garden_event.id, postpone: true, start_date: params[:start_date]), method: :put do %>
                        <div class="round-button orange m-2">
                          <i class="fas fa-redo-alt round-txt-button"></i>
                        </div>
                      <% end %>
                    </div>
                    <div class="user-button-event">
                      <% if !garden_event.users.empty? %>
                        <% garden_event.users.each do |user| %>
                          <div class="d-flex pr-1">
                            <div class="txt-avatar m-2 <%= user.color %>"><%= user.first_name[0] %></div>
                          </div>
                        <% end %>
                      <% else %>
                        <div class="dropleft">
                          <div class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <div class="round-button green m-2">
                              <i class="fas fa-user-plus round-txt-button"></i>
                            </div>
                          </div>
                          <div class="dropdown-menu">
                            <div class="d-flex">
                              <% @workers.each do |worker| %>
                                <%= link_to farm_user_events_path(event: garden_event, worker: worker.id), :method => :post do %>
                                  <div class="d-flex pr-1 pointer">
                                    <div class="txt-avatar m-2 <%= worker.color %>">
                                      <%= "🙏🏻" if worker.first_name == "Bras" %>
                                      <%= worker.first_name[0] %>
                                    </div>
                                  </div>
                                <% end %>
                              <% end %>
                            </div>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>

                <!-- drawer comment tour des jardins -->
                <%= render "pages/dashboard_drawers/drawer_comment_garden_event", garden_event_id: garden_event.id, garden_event_description: garden_event.description, garden_event_details: garden_event.details, garden_event_comment: garden_event.comment %>


                <!-- À AJOUTER À LA CLASSE DRAWER SI ON VEUT QUE LE DRAWER SOIT OUVERT QUAND ON A MIS À JOUR -->
                 <%#= params[:event].to_i == garden_event.id ? 'is-active is-visible' : '' %>

                <!-- drawer edit tour des jardins -->
                <%= render "pages/dashboard_drawers/drawer_edit_garden_event", garden_event_id: garden_event.id, garden_event_description: garden_event.description, garden_event_details: garden_event.details, garden_event_comment: garden_event.comment, farm: @farm, event: @event %>
              <% end %>
            </div>
          </div>
          <div class="d-flex justify-content-end card-bottom-section-with-icon">
            <a href="#" data-toggle="modal" data-target="#modal-new-garden-event">
              <div class="card-bottom-right-triangle red">
                <i class="fas fa-plus"></i>
              </div>
            </a>
          </div>
          <%= render "create_event_modal", farm: @farm, event: @new_event %>
        </div>
      </div>
    </div>
  </div>

  <!-- LES VENTES les ventes -->
  <%= render "pages/dashboard_sections/sales" %>

  <div class="scrolltop-wrap">
    <div id="link-to-calendar-heading">
      <%= link_to "#" do %>
        <div class="round-button lightgrey m-1">
          <i class="fas fa-chevron-up white round-txt-button"></i>
          <path d="M14.83 30.83l9.17-9.17 9.17 9.17 2.83-2.83-12-12-12 12z"></path>
        </div>
      <% end %>
    </div>
    <div id="link-to-decharge-mentale-anchor">
      <%= link_to :anchor => "decharge-mentale-anchor" do %>
        <div class="round-button orange m-1">
          <%= image_tag "brain.png", class: "round-img-button" %>
          <path d="M14.83 30.83l9.17-9.17 9.17 9.17 2.83-2.83-12-12-12 12z"></path>
        </div>
      <% end %>
    </div>
    <div id="link-to-tour-des-jardins-anchor">
      <%= link_to :anchor => "tour-des-jardins-anchor" do %>
        <div class="round-button red m-1">
          <i class="fas fa-eye white round-txt-button"></i>
          <path d="M14.83 30.83l9.17-9.17 9.17 9.17 2.83-2.83-12-12-12 12z"></path>
        </div>
      <% end %>
    </div>
  </div>
</div>

